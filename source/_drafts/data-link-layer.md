---
title: 数据链路层
categories:
tags:
---

## 什么是数据链路层

数据链路层位于OSI参考模型的第二层，向下接触物理层，向上服务网络层。

数据链路层的目的是将帧（区别于比特）按序、高效以及可靠的传递到目标机器的数据链路层中。

为此，数据链路层需要处理以下几个问题：

1. 传输信道受噪音等其他因素影响，帧在经过受影响的信道时，可能会发生改变甚至完全丢失；
2. 发送方与接收方的性能可能差别很大，若发送方性能很强大，但是接收方相较之下处理能力较弱。在不加控制的情况下，发送方的数据很可能将接收方淹没（swamped）。

## 数据链路层提供的服务

数据链路层根据信道可靠程度的不同向网络层提供三种服务：

1. 无应答的无连接服务（Unacknowledged Connectionless Service）；
2. 有应答的无连接服务；
3. 有应答的面向连接服务。

### 无应答的无连接服务

在无应答的无连接服务中，数据链路层所做的仅仅是将数据帧发送到目的机器上，发送之前不需要建立连接，目的机器不需要应答，也不需要尝试检错或者纠错。错误处理由上层进行。

无应答的无连接服务适用于错误率极小的信道，如*以太网（Ethernet）*就采用这种方式。实时性要求很高（比起正确性）的网络，如语音通话也适用于这种方式。

### 有应答的无连接服务

在有应答的无连接服务中，通信之前仍然不需要建立连接。但是当接收方成功接收到一帧时，接收方需要向发送方发送一个应答，表示接收方已经接受到某一数据帧。当发送方在一定时间内没能够接收到应答，发送方会重新发送这一帧。

这种服务用于错误率较高的信道上，如*WiFi（802.11）*。

### 有应答的面向连接的服务

这是最复杂的一种服务，同时也保证了最好的正确性。在通信之前，双方需要建立连接，然后按应答机制进行通信。在通信完成后，双方需要释放连接。

这种服务主要用在极不可靠的信道上，如长距离的电话线网络、卫星通信上。

## 分帧（Framing）

网络数据从其底层而言还是一个字节流。如何在字节流中找出哪一部分属于哪一帧是分帧要考虑的问题。分帧从本质上来说还是要在字节流中找出每一帧的开头。

为了让接收方方便地定位帧的开头，有四种组成帧的方法：

1.  Byte Count
2. Flag Bytes with byte stuffing
3. Flag bits witg byte stuffing
4. Physical layer coding violation

### Byte Count

Byte Count很简单。帧的第一个Byte直接表示该帧的长度。这样帧的起始点与终止点就唯一确定了。

但是问题在于，在传输过程中，某一帧完全丢失之后，接收方将会无法区分以后所有帧的开头（失去同步）。因此Byte Count的方法一般不单独使用。

### Flag Byte with Byte Stuffing

这种方法专门选出一个编码作为Flag Byte，当接收方看到这一编码时就可以确定帧的开头与结尾。但是选出的编码可能会作为数据，因此用类似转义字符的概念，选出一个转义符（escape，ESC），当接收方看到ESC时，保持紧接着一个字节的原意。

这种方法用在PPP（Point to Point Protocol）中。


### Flag Bits with Bit Stuffing

上面一种方法使用整个Byte作为起始标记。网络设备具有逐bit的处理能力。因此将上一节的概念缩小到bit上也应该是可行的。

如HDLC（High-level Data Link Control）协议采用`0x7E(01111110)`作为Flag Byte。Bit 填入规则是每遇到连续的5个1，自动在其后面填入0。

USB（Universal Serial Bus）使用这种协议。

### Physical Layer Coding Violations

为了保证数据传输时的可靠性，物理层常常使用冗余的方式（如用4位表示8个状态）去编码。物理层可能在正常传输中不会使用一些编码。数据链路层得以使用这些编码作为起始标记。

许多协议使用以上提到的方法的混合。

## 错误控制

在无应答的无连接服务中，数据链路层不需要提供错误控制。

在有应答的服务中，数据链路层主要通过维护一个定时器和序列号，去追踪某个数据帧是否成功到达对方。如果在定时器超时时仍然未收到应答，数据链路层会认为数据帧在传输中丢失，然后重发该数据帧。

## 流量控制

当高速机器向低速机器通信时，高速机器的信息可能淹没低速信息。此时，引入流量控制是有必要的。

流量控制方法有两种：1. *基于反馈*的流量控制；2. *基于速率*的流量控制。

在数据链路层中主要使用基于反馈的流量控制。

## 错误侦测以及错误纠正

在数据链路层中，由于信道可靠性的原因，错误是常见的。数据链路层有两种处理错误的方式：（1）错误侦测：通过某些方式（如奇偶校验）确定数据帧是否是错误的。（2）错误纠正：数据链路层尝试将错误的地方纠正成正确的。两者都是通过类似物理层中使用到的方法实现：在编码中增加冗余信息。

使用错误纠正的性能代价要高于错误侦测，因此错误纠正只用在不可靠的信道上。

### 错误纠正编码

有四种错误纠正编码：

1. Humming Code
2. Binary Convolutional Code
3. Reed-Solomon Code
4. Low-Density Parity Check(LDPC) Code
