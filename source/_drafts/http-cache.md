---
title: HTTP缓存
categories:
  - Technology
tags:
  - HTTP
  - 缓存
---

本文将会介绍 HTTP 中缓存。
缓存是 Web 应用中重要的一环。正如计算机系统中所有的缓存设计，Web 缓存可以有效地：

- 减少*不必要的数据传输*，节省网络流量费用；
- 缓解*网络瓶颈*，在服务器有限带宽下加快页面的加载速度；
- 减少对*原始服务器的需求*，服务器可以响应得更快而且避免可以过载；
- 通过部署离客户更近的缓存服务器，减少*传输距离造成的延迟*；

缓存要解决的核心问题是：

- 一致性：缓存如何保证其缓存的文件与服务器上的文件是一致的。
  很显然，没有人希望从缓存上拿到页面的过去版本。
- 高效性：在 Web 缓存中，缓存与服务器一般并不在一起，两者仍然需要通过网络进行通信。
  缓存的功用之一就是减少不必要的网络传输。然而，为了保持数据同步，
  缓存不得不使用网络。为了最小限度的使用网络，
  缓存需要一个高效的协议来与服务器就缓存的“新鲜度”进行交流。

## 总体过程

既然要最小化缓存与服务器之间的网络通信，服务器可以给文件设置一个**过期时间**，
在该过期时间之前，缓存可以*认为*缓存下来的文件是新鲜的（与服务器是同步的），
当客户端需要的时候，可以使用缓存文件来作为原始文件返回给客户端。
当超过过期时间之后，缓存需要与服务器对缓存文件进行*再验证（Revalidation）*，
如果服务器上的文件与缓存文件不一致，服务器则发送最新的文件给缓存；如果一致，
服务器发送一个 304（Not Modified）响应给缓存。

一个简单的 GET 请求的缓存过程如下图所示：

![GET请求的缓存过程](cache-processing.png)

从上面的描述，可以看到缓存的两个核心过程是：

- 服务器如何设置过期时间；
- 与缓存如何与服务器进行再验证；

## 设置文件过期时间

在 HTTP 中，服务器可以通过两种方式设置文件的过期时间，
一种是 HTTP/1.0 中出现的`Expires: <datetime>`响应头，另外一种是 HTTP/1.1 中出现的
`Cache-Control: max-age=<sec>`响应头：

### `Expires: <datetime>`

服务器可以通过`Expires`请求头设置一个文件过期时的时间戳，如`Expires: Fri, 05 Jul 2002, 05:00:00 GMT`，表示文件在零时区的 2002 年 7 月 5 日 5 点整过期。

### `Cache-Control: max-age=<sec>

服务器可以通过`Cache-Control: max-age=<sec>`设置文件距离过期的最大**秒数**，如`Cache-Control: max-age=484200`表示距离文档过期还有 484200 秒，大概 5 天时间。

## 缓存再验证
